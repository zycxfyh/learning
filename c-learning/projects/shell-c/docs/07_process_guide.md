# ðŸ§¬ æ·±å…¥ç†è§£ Linux è¿›ç¨‹ï¼šåˆ†èº«ä¸Žå¤ºèˆ

åœ¨å†™ Shell çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æŽ¥è§¦äº†æ“ä½œç³»ç»Ÿæœ€â€œé­”æ³•â€çš„ä¸‰ä¸ªå‡½æ•°ï¼š`fork`, `exec`, `wait`ã€‚
å¦‚æžœä¸ç†è§£å®ƒä»¬ï¼ŒUnix ç³»ç»Ÿå¯¹ä½ æ¥è¯´å°±æ˜¯ä¸€ä¸ªé»‘ç›’ã€‚

è®©æˆ‘ä»¬ç”¨**â€œå…‹éš†äººâ€**çš„æ¯”å–»æ¥å½»åº•é€šè¿‡è¿™ä¸€å…³ã€‚

---

## 1. ä»€ä¹ˆæ˜¯è¿›ç¨‹ (Process)ï¼Ÿ
æƒ³è±¡ä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ä¸€ä¸ª**æ­£åœ¨å¹²æ´»çš„å·¥äºº**ã€‚
*   ä»–æœ‰è‡ªå·±çš„**èº«ä»½è¯** (PID)ã€‚
*   ä»–æœ‰è‡ªå·±çš„**å·¥ä½œå°** (å†…å­˜ç©ºé—´/å˜é‡)ã€‚
*   ä»–æœ‰è‡ªå·±çš„**å·¥å…·ç®±** (æ–‡ä»¶æè¿°ç¬¦)ã€‚

---

## 2. Forkï¼šå½±åˆ†èº«ä¹‹æœ¯ (The Clone)

`fork()` æ˜¯ Unix ä¸–ç•Œæœ€å¥‡ç‰¹çš„è®¾å®šï¼š**å®ƒä¸äº§ç”Ÿæ–°ä¸œè¥¿ï¼Œå®ƒåªå¤åˆ¶è‡ªå·±ã€‚**

*   **æ“ä½œ**ï¼šShell è°ƒç”¨ `fork()`ã€‚
*   **ç»“æžœ**ï¼šçž¬é—´ï¼Œä¸–ç•Œä¸Šå¤šäº†ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„ Shellï¼ˆå­è¿›ç¨‹ï¼‰ã€‚
    *   ä»£ç ä¸€æ¨¡ä¸€æ ·ã€‚
    *   å˜é‡ä¸€æ¨¡ä¸€æ ·ã€‚
    *   è¿žåˆšæ‰æ‰§è¡Œåˆ°äº†å“ªä¸€è¡Œéƒ½ä¸€æ¨¡ä¸€æ ·ã€‚
*   **å”¯ä¸€çš„åŒºåˆ«**ï¼š
    *   çˆ¶è¿›ç¨‹æ”¶åˆ°çš„è¿”å›žå€¼æ˜¯ **å­è¿›ç¨‹çš„ ID** (å› ä¸ºå®ƒæ˜¯å®¶é•¿ï¼Œå¾—çŸ¥é“å­©å­å«å•¥)ã€‚
    *   å­è¿›ç¨‹æ”¶åˆ°çš„è¿”å›žå€¼æ˜¯ **0** (å› ä¸ºå®ƒåˆšå‡ºç”Ÿï¼Œè¿˜æ²¡åå­—)ã€‚

```c
pid_t pid = fork();
if (pid == 0) {
    // æˆ‘æ˜¯å…‹éš†äºº (å­è¿›ç¨‹)
} else {
    // æˆ‘æ˜¯æœ¬ä½“ (çˆ¶è¿›ç¨‹)
}
```

---

## 3. Execï¼šçµé­‚å¤ºèˆ (The Transformation)

å¦‚æžœå­è¿›ç¨‹æ°¸è¿œå’Œçˆ¶è¿›ç¨‹ä¸€æ ·ï¼Œé‚£å°±æ²¡æ„ä¹‰äº†ã€‚
æˆ‘ä»¬ç”Ÿå‡ºå­è¿›ç¨‹ï¼Œæ˜¯ä¸ºäº†è®©å®ƒåŽ»å¹²åˆ«çš„æ´»ï¼ˆæ¯”å¦‚è¿è¡Œ `ls`ï¼‰ã€‚

è¿™å°±æ˜¯ `execvp()` çš„ä½œç”¨ï¼š**è„‘ç§»æ¤**ã€‚

*   **æ“ä½œ**ï¼šå­è¿›ç¨‹è°ƒç”¨ `execvp("ls", args)`ã€‚
*   **ç»“æžœ**ï¼š
    1.  æ“ä½œç³»ç»Ÿæ¸…ç©ºå­è¿›ç¨‹çš„å¤§è„‘ï¼ˆå†…å­˜ï¼‰ã€‚
    2.  æ“ä½œç³»ç»ŸæŠŠ `ls` ç¨‹åºçš„ä»£ç åŠ è½½è¿›æ¥ã€‚
    3.  **ä»Žè¿™ä¸€åˆ»èµ·ï¼Œå­è¿›ç¨‹å°±ä¸å†æ˜¯ Shell äº†ï¼Œå®ƒå˜æˆäº† lsã€‚**
*   **æ³¨æ„**ï¼š`exec` å¦‚æžœæˆåŠŸï¼Œä»£ç å°±**æ°¸è¿œä¸ä¼š**è¿”å›žäº†ï¼ˆå› ä¸ºåŽŸæ¥çš„è„‘å­å·²ç»è¢«ä¸¢æŽ‰äº†ï¼‰ã€‚

---

## 4. Waitï¼šæœ›å­æˆé¾™ (The Parent)

çˆ¶è¿›ç¨‹ï¼ˆShellï¼‰ç”Ÿäº†å­©å­ï¼ˆForkï¼‰ï¼Œå­©å­ä¹Ÿå˜èº«åŽ»å¹²æ´»äº†ï¼ˆExecï¼‰ã€‚
è¿™æ—¶å€™çˆ¶è¿›ç¨‹è¯¥å¹²å˜›ï¼Ÿ
ç­”ï¼š**ç­‰ (Block)**ã€‚

å¦‚æžœä¸ç­‰ï¼Œçˆ¶è¿›ç¨‹å°±ä¼šç«‹åˆ»æ‰“å°ä¸‹ä¸€ä¸ª `myshell> ` æç¤ºç¬¦ã€‚ç»“æžœå°±æ˜¯ï¼š
*   å±å¹•ä¸Š `ls` çš„è¾“å‡ºå’Œ Shell çš„æç¤ºç¬¦æ··åœ¨ä¸€èµ·ï¼Œä¹±å¥—äº†ã€‚
*   æˆ–è€…å­è¿›ç¨‹å˜æˆäº†â€œåƒµå°¸è¿›ç¨‹â€ (Zombie)ã€‚

`waitpid()` å°±æ˜¯è®©çˆ¶è¿›ç¨‹æ¬ä¸ªå°æ¿å‡³ååœ¨é‚£ï¼Œç›´åˆ°æ”¶åˆ°é€šçŸ¥ï¼šâ€œä½ çš„å­©å­ `ls` å¹²å®Œæ´»é€€å‡ºäº†â€ã€‚

---

## æ€»ç»“å›¾ç¤º

```mermaid
sequenceDiagram
    participant Shell(Parent)
    participant Shell(Child)
    participant LS(Program)

    Shell(Parent)->>Shell(Child): 1. fork() (åˆ†èº«)
    Note right of Shell(Child): æˆ‘æ˜¯æ–°çš„ Shell
    
    Shell(Child)->>LS(Program): 2. execvp() (å˜èº«!)
    Note right of LS(Program): æˆ‘ä¸å†æ˜¯ Shell äº†ï¼Œæˆ‘æ˜¯ ls
    
    Shell(Parent)->>Shell(Parent): 3. wait() (ç­‰å¾…...)
    activate Shell(Parent)
    
    LS(Program)-->>Shell(Parent): ä»»åŠ¡ç»“æŸ (exit)
    deactivate Shell(Parent)
    
    Shell(Parent)->>User: æ‰“å° "myshell> "
```
